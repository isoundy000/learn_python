/**
 * Created by wangrui on 14/12/27.
 */

var USEGOLD_SYSTEM = {
    1: {
        "name": "开服狂欢",
        "data": [
            {
                "name": "7日礼包",
                "data": ["begin7day"],
                "level": 1,
                "days": "7"
            },
        ]
    },
    2: {
        "name": "武将招募",
        "data": [
            {
                "name": "武将招募",
                "data": ["recruit"],
                "level": 2,
                "days": "长期"
            },
        ]
    },
    3: {
        "name": "商店",
        "data": [
            {
                "name": "黑市商店",
                "data": ["blackmarket_refresh", "blackmarkguy"],
                "level": 16,
                "days": "长期"
            },
            {
                "name": "蛋蛋商店",
                "data": ["mozhaoshop"],
                "level": 35,
                "days": "长期"
            },
            {
                "name": "神魂商店",
                "data": ["mysteryshop_refresh"],
                "level": 18,
                "days": "长期"
            },
            {
                "name": "冠军试炼商店",
                "data": ["trial"],
                "level": 50,
                "days": "长期"
            }
        ]
    },
    4: {
        "name": "商城",
        "data": [
            {
                "name": "道具商城",
                "data": ["shop"],
                "level": 1,
                "days": "长期"
            },
            {
                "name": "时装商城",
                "data": ["activity_q", "fashiondress_buy", "protagonist_fashion_reset"],
                "level": 1,
                "days": "长期"
            },
            {
                "name": "礼包商城",
                "data": ["giftbag",],
                "level": 1,
                "days": "长期"
            },
        ]
    },
    5: {
        "name": "奇遇",
        "data": [
            {
                "name": "高人指点",
                "data": ["encounter_exp",],
                "level": 1,
                "days": "长期"
            },
            {
                "name": "奇遇武将",
                "data": ["encounter_general",],
                "level": 1,
                "days": "长期"
            },
            {
                "name": "卷宗寻宝",
                "data": ["encounter_search",],
                "level": 1,
                "days": "长期"
            },
            {
                "name": "奇遇道具",
                "data": ["encounter_shop",],
                "level": 1,
                "days": "长期"
            },
        ]
    },
    6: {
        "name": "普通副本",
        "data": [
            {
                "name": "重置副本",
                "data": ["copykillreset",],
                "level": 1,
                "days": "长期"
            },
        ]
    },
    7: {
        "name": "活动副本",
        "data": [
            {
                "name": "银币副本挑战次数",
                "data": ["coincopybuy",],
                "level": 23,
                "days": "长期"
            },
            {
                "name": "经验副本挑战次数",
                "data": ["expcopybuy",],
                "level": 23,
                "days": "长期"
            },
            {
                "name": "锻造石副本挑战次数",
                "data": ["stonecopybuy",],
                "level": 31,
                "days": "长期"
            },
            {
                "name": "阵符副本挑战次数",
                "data": ["zhenfucopybuy",],
                "level": 50,
                "days": "长期"
            },
            {
                "name": "升星石副本挑战次数",
                "data": ["upstarcopybuy",],
                "level": 55,
                "days": "长期"
            },
        ]
    },
    8: {
        "name": "体力",
        "data": [
            {
                "name": "购买体力",
                "data": ["stamina",],
                "level": 1,
                "days": "长期"
            },
        ]
    },
    9: {
        "name": "杀气",
        "data": [
            {
                "name": "购买杀气",
                "data": ["energy",],
                "level": 1,
                "days": "长期"
            },
        ]
    },
    10: {
        "name": "竞技场",
        "data": [
            {
                "name": "购买挑战次数",
                "data": ["athletics",],
                "level": 12,
                "days": "长期"
            },
        ]
    },
    11: {
        "name": "灭神殿",
        "data": [
            {
                "name": "灭神殿",
                "data": ["mieshendianmodupcdclear", "mieshendianreset"],
                "level": 15,
                "days": "长期"
            },
        ]
    },
    12: {
        "name": "观星台",
        "data": [
            {
                "name": "观星台",
                "data": ["watchstarEx", "watchstar_change"],
                "level": 17,
                "days": "长期"
            },
        ]
    },
    13: {
        "name": "好友副本",
        "data": [
            {
                "name": "购买次数",
                "data": ["friendcopy",],
                "level": 19,
                "days": "长期"
            },
        ]
    },
    14: {
        "name": "群仙屠龙",
        "data": [
            {
                "name": "浴火重生",
                "data": ["worldboss1",],
                "level": 21,
                "days": "长期"
            },
        ]
    },
    15: {
        "name": "蓬莱仙洞",
        "data": [
            {
                "name": "蓬莱仙洞",
                "data": ["penglai3cardopen", "penglai3dice", "penglai3reset"],
                "level": 22,
                "days": "长期"
            },
        ]
    },
    16: {
        "name": "王的男人",
        "data": [
            {
                "name": "购买次数",
                "data": ["kingmanbuy",],
                "level": 30,
                "days": "长期"
            },
        ]
    },
    17: {
        "name": "天庭银座",
        "data": [
            {
                "name": "元宝训练",
                "data": ["patrol",],
                "level": 1,
                "days": "长期"
            },
        ]
    },
    18: {
        "name": "过关斩将",
        "data": [
            {
                "name": "过关斩将",
                "data": ["overpasschangeboss", "ovserpassbuy"],
                "level": 45,
                "days": "长期"
            },
        ]
    },
    19: {
        "name": "伙伴",
        "data": [
            {
                "name": "伙伴培养",
                "data": ["generalfoster",],
                "level": 30,
                "days": "长期"
            },
        ]
    },
    20: {
        "name": "魔宫",
        "data": [
            {
                "name": "翅膀激活",
                "data": ["wingactivation",],
                "level": 35,
                "days": "长期"
            },
        ]
    },
    21: {
        "name": "装备",
        "data": [
            {
                "name": "装备洗练",
                "data": ["equipbaptizepreview",],
                "level": 26,
                "days": "长期"
            },
        ]
    },
    22: {
        "name": "乾坤炉",
        "data": [
            {
                "name": "伙伴重生",
                "data": ["general_reset",],
                "level": 18,
                "days": "长期"
            },
            {
                "name": "装备重生",
                "data": ["equip_reset",],
                "level": 18,
                "days": "长期"
            },
            {
                "name": "时装重生",
                "data": ["protagonist_fashion_reset",],
                "level": 18,
                "days": "长期"
            },
        ]
    },
    23: {
        "name": "公会",
        "data": [
            {
                "name": "公会",
                "data": ["gangcreate", "gangpray", "gangsetname", "inspiregold"],
                "level": 19,
                "days": "长期"
            },
        ]
    },
    24: {
        "name": "魔宠",
        "data": [
            {
                "name": "技能重置",
                "data": ["petpassiveskillreset",],
                "level": 21,
                "days": "长期"
            },
        ]
    },
    25: {
        "name": "猎命",
        "data": [
            {
                "name": "元宝猎命",
                "data": ["soulhunt",],
                "level": 41,
                "days": "长期"
            },
        ]
    },
    26: {
        "name": "法宝",
        "data": [
            {
                "name": "法宝锻造",
                "data": ["instrumentforgepreview",],
                "level": 31,
                "days": "长期"
            },
        ]
    },
    27: {
        "name": "活动",
        "data": [
            {
                "name": "聚宝盆",
                "data": ["cornucopia_buy",],
                "level": 25,
                "days": "长期"
            },
            {
                "name": "珍品折扣兑换",
                "data": ["gemdiscountshop",],
                "level": 1,
                "days": "长期"
            },
            {
                "name": "珍品折扣1兑换",
                "data": ["gemdiscountshop1",],
                "level": 1,
                "days": "长期"
            },
            {
                "name": "珍品折扣2兑换",
                "data": ["gemdiscountshop2",],
                "level": 1,
                "days": "长期"
            },
            {
                "name": "珍品折扣3兑换",
                "data": ["gemdiscountshop3",],
                "level": 1,
                "days": "长期"
            },
            {
                "name": "成长计划",
                "data": ["growplan",],
                "level": 1,
                "days": "长期"
            },
            {
                "name": "限时商店",
                "data": ["limit_buy", "limit_refresh"],
                "level": 1,
                "days": "2天"
            },
            {
                "name": "vip福利",
                "data": ["vip_welfare_exchange",],
                "level": 1,
                "days": "长期"
            },
            {
                "name": "老司机",
                "data": ["olddriver",],
                "level": 1,
                "days": "3天"
            },
            {
                "name": "大转盘",
                "data": ["dragonboatluckdraw",],
                "level": 40,
                "days": "长期"
            },
            {
                "name": "老虎鸡",
                "data": ["spinampwin",],
                "level": 1,
                "days": "3天"
            },
            {
                "name": "八戒圆梦",
                "data": ["god_down",],
                "level": 1,
                "days": "3天"
            },
            {
                "name": "限时礼包",
                "data": ["timegift",],
                "level": 1,
                "days": "长期"
            },
            {
                "name": "触发礼包",
                "data": ["trigger_gift",],
                "level": 1,
                "days": "长期"
            },
        ]
    }
};

var $select_game1 = $("#select_game1");
var $select_game2 = $("#select_game2");


var USE_GOLD_TYPE = {
    "begin7day": "7日礼包",
    "recruit": "武将招募",
    "blackmarket_refresh": "黑市商店刷新",
    "blackmarkguy": "黑市商店购买",
    "mozhaoshop": "蛋蛋商店",
    "mysteryshop_refresh": "神魂商店",
    "trial": "冠军试炼商店",
    "shop": "道具商城",
    "activity_q": "时装商城",
    "fashiondress_buy": "时装商城购买",
    "protagonist_fashion_reset": "时装商城重置",
    "giftbag": "礼包商城",
    "encounter_exp": "高人指点",
    "encounter_general": "奇遇武将",
    "encounter_search": "卷宗寻宝",
    "encounter_shop": "奇遇道具",
    "copykillreset": "重置副本",
    "coincopybuy": "银币副本挑战次数",
    "expcopybuy": "经验副本挑战次数",
    "stonecopybuy": "锻造石副本挑战次数",
    "zhenfucopybuy": "阵符副本挑战次数",
    "upstarcopybuy": "升星石副本挑战次数",
    "stamina": "购买体力",
    "energy": "购买杀气",
    "athletics": "竞技场",
    "mieshendianmodupcdclear": "灭神殿清除CD",
    "mieshendianreset": "灭神殿重置",
    "watchstarEx": "观星台",
    "watchstar_change": "观星台兑换",
    "friendcopy": "好友副本",
    "worldboss1": "浴火重生",
    "penglai3cardopen": "蓬莱仙岛翻牌",

    "penglai3dice": "蓬莱仙岛随机",
    "penglai3reset": "蓬莱仙岛重置",
    "kingmanbuy": "王的男人",
    "patrol": "天庭银座",
    "overpasschangeboss": "过关斩将",
    "ovserpassbuy": "过关斩将购买",
    "generalfoster": "伙伴培养",
    "wingactivation": "翅膀激活",
    "equipbaptizepreview": "装备洗练",
    "general_reset": "伙伴重生",
    "equip_reset": "装备重生",
    "gangcreate": "创建公会",
    "gangpray": "公会拜神",
    "gangsetname": "公会改名",
    "inspiregold": "公会战鼓舞",
    "petpassiveskillreset": "技能重置",
    "soulhunt": "猎命",
    "instrumentforgepreview": "法宝锻造",
    "cornucopia_buy": "聚宝盆",
    "gemdiscountshop": "珍品折扣兑换",
    "gemdiscountshop1": "珍品折扣兑换1",
    "gemdiscountshop2": "珍品折扣兑换2",
    "gemdiscountshop3": "珍品折扣兑换3",
    "growplan": "成长计划",
    "limit_buy": "限时商店购买",
    "limit_refresh": "限时商店刷新",
    "vip_welfare_exchange": "vip福利",
    "olddriver": "老司机",
    "dragonboatluckdraw": "大转盘",
    "spinampwin": "老虎鸡",
    "god_down": "八戒圆梦",
    "timegift": "限时礼包",
    "trigger_gift": "触发礼包"
};

getGameServerData($("#select_gameserver"), 2);
getGameServerData($select_game1, 1);
getGameServerData($select_game2, 1);


handleDatePickers();
$("#start_date").val(getNowFormatDate(0));
$("#end_date").val(getNowFormatDate(0));

$("#consume_start_date").val(getNowFormatDate(1));
$("#consume_end_date").val(getNowFormatDate(1));

$("#consume_start_date_2").val(getNowFormatDate(0));
$("#consume_end_date_2").val(getNowFormatDate(0));


var init_gold_type = function(){
    var str_info = "";
    for(var u in USE_GOLD_TYPE){
        str_info += "<label class=\"checkbox-inline\"><input checked type=\"checkbox\" name=\"usegold_type\" value=\"" +
                    u + "\">" + USE_GOLD_TYPE[u] + "</label>";

    }
    $("#consume_type").html(str_info);
};
init_gold_type();


$("#select_all").bind("click", function(e){
    e.preventDefault();
    $("input[name='usegold_type']").prop("checked", true);
    $("input[name='usegold_type']").parent("span").addClass("checked");
});

$("#no_select_all").bind("click", function(e){
    e.preventDefault();
    $("input[name='usegold_type']").each(function(){
        if ($(this).is(":checked")){
            $(this).prop("checked", false);
            $(this).parent("span").removeClass("checked");
        }
        else{
            $(this).prop("checked", true);
            $(this).parent("span").addClass("checked");
        }
    });
});


function display_table(data){
    var str_info = "";
    var total_array = [];
    if (data.length != 0) {
        for (var k=0; k<data.length; k++) {
            var total = 0;
            for (var sk in data[k]["data"]){
                total += parseInt(data[k]["data"][sk]["g_gold"]);
            }
            total_array.push(total);
            $("#dau_title_" + k).html("DAU:" + data[k]["total"]);
        }
        for (var us in USEGOLD_SYSTEM) {
            for (var i = 0; i < USEGOLD_SYSTEM[us]["data"].length; i++) {
                for(var dt =0;dt < data.length; dt++) {
                    if (dt == 0) {
                        str_info += "<tr class='success'>";
                    }
                    else {
                        str_info += "<tr class='danger'>";
                    }
                    var max1 = 0;
                    var max2 = 0;
                    if (i == 0 && dt ==0) {
                        var sys_name = USEGOLD_SYSTEM[us]["name"];
                        str_info += "<td>" + sys_name + "</td>";
                    }
                    else{
                        str_info += "<td></td>";
                    }
                    if(dt == 0){
                        var sys_name2 = USEGOLD_SYSTEM[us]["data"][i]["name"];
                        str_info += "<td>" + sys_name2 + "</td>";
                    }
                    else{
                        str_info += "<td></td>";
                    }
                    var total_ = USEGOLD_SYSTEM[us]["data"][i]["level"] + "/" + USEGOLD_SYSTEM[us]["data"][i]["days"];
                    str_info += "<td>" + total_ + "</td>";
                    var total_c_count = 0;
                    var percent = 0.0;
                    var g_gold = 0;
                    var total_p_count_json = {};
                    for (var m = 0; m < USEGOLD_SYSTEM[us]["data"][i]["data"].length; m++) {
                        var consume_type = USEGOLD_SYSTEM[us]["data"][i]["data"][m];
                        if (data[dt]["data"].hasOwnProperty(consume_type)) {
                            g_gold += data[dt]["data"][consume_type]["g_gold"];
                            total_c_count += data[dt]["data"][consume_type]["c_count"];
                            for (var n in data[dt]["data"][consume_type]["p_count"]) {
                                total_p_count_json[n] = ""
                            }
                        }
                    }
                    var total_p_count = 0;
                    for (var key in total_p_count_json) {
                        total_p_count++;
                    }
                    str_info += "<td>" + g_gold + "</td>";
                    if (total_array[dt] != 0) {
                        percent = parseFloat(g_gold / total_array[dt] * 100).toFixed(2);
                    }
                    str_info += "<td>" + percent + "%</td>";
                    str_info += "<td>" + total_c_count + "</td>";
                    str_info += "<td>" + total_p_count + "</td>";
                    var avg_count = 0;
                    var avg_p_count = 0;
                    if (total_p_count != 0) {
                        avg_count = parseFloat(total_c_count / total_p_count).toFixed(2);
                        avg_p_count = parseFloat(g_gold / total_p_count).toFixed(2);
                    }
                    str_info += "<td>" + avg_count + "</td>";
                    str_info += "<td>" + avg_p_count + "</td>";
                    str_info += "<td>" + max1 + "</td>";
                    str_info += "<td>" + max2 + "</td>";
                    str_info += '</tr>';
                }
            }
        }
    }
    else {
        str_info += "<tr>";
        str_info += '<td colspan="7" class="text-center"><span class="label label-danger">无数据</span></td>';
        str_info += '</tr>';
    }

    $("#use_gold_list").html(str_info);
}


function query_use_gold(tag){
    var game_server = 0;
    var start_date = "";
    var end_date = "";
    if (tag == 1){
        game_server = $("#select_game1").val();
        start_date = $("#consume_start_date").val();
        end_date = $("#consume_end_date").val();
    }
    else{
        game_server = $("#select_game2").val();
        start_date = $("#consume_start_date_2").val();
        end_date = $("#consume_end_date_2").val();
    }
    var data = {
          game:game_server, start_date:start_date, end_date:end_date
    };
    var return_data = null;
    var success = function(data){
        return_data = data;
    };
    my_ajax(true, "/queryusegold2", 'get', data, false, success);
    return return_data;
}

var SECOND_TAG = false;

function init_usegold(){
    var data1 = query_use_gold(1);
    if (SECOND_TAG){
        var data2 = query_use_gold(2);
        display_table([data1, data2]);
    }
    else{
        display_table([data1]);
    }
}

init_usegold();


$("#enable_b_server").on("click", function(e){
    e.preventDefault();
    if ($(this).html() == "+"){
        $("#div_server2").removeClass("hidden");
        $("#div_start_time").removeClass("hidden");
        $("#div_end_time").removeClass("hidden");
        $(this).removeClass("green");
        $(this).addClass("red");
        $(this).html("-");
        SECOND_TAG = true;
        init_usegold();
    }
    else{
        $("#div_server2").addClass("hidden");
        $("#div_start_time").addClass("hidden");
        $("#div_end_time").addClass("hidden");
        $(this).removeClass("red");
        $(this).addClass("green");
        $(this).html("+");
        SECOND_TAG = false;
        init_usegold();
    }
});

$select_game1.on("change", function(e){
    e.preventDefault();
    init_usegold();
});

$("#div_whole_start").on("changeDate", function(e){
    e.preventDefault();
    init_usegold();
});

$("#div_whole_end").on("changeDate", function(e){
    e.preventDefault();
    init_usegold();
});

$select_game2.on("change", function(e){
    e.preventDefault();
    SECOND_TAG = true;
    init_usegold();
});

$("#div_whole_start_2").on("changeDate", function(e){
    e.preventDefault();
    SECOND_TAG = true;
    init_usegold();
});

$("#div_whole_end_2").on("changeDate", function(e){
    e.preventDefault();
    SECOND_TAG = true;
    init_usegold();
});

$("#query_button").bind("click", function(e){
    e.preventDefault();
    var select_gameserver = $("#select_gameserver").val();
    var start_date = $("#start_date").val();
    var end_date = $("#end_date").val();
    var role_id = $("#role_id").val();
    var usegold_type = "";
    $("input[name='usegold_type']:checked").each(function(){
        usegold_type += $(this).val() + ",";
    });
    var page_content = $('.page-content');
    App.blockUI(page_content, false);
    $.ajax({
        type: 'get',
        url: '/queryusegold',
        data: {
            game:select_gameserver, role_id: role_id,
            usegold_type: usegold_type, start_date:start_date, end_date:end_date},
        dataType: 'JSON',
        success: function (data) {
            App.unblockUI(page_content);
            var str_info = "";
            var dataset = [];
            var total = 0;
            if (data.length != 0){
                for(var k in data){
                    total += parseInt(data[k]["g_gold"]);
                }
                for(var i in data){
                    str_info += "<tr>";
                    str_info += "<td>" + USE_GOLD_TYPE[i] + "</td>";
                    var percent = 0.0;
                    if (total != 0){
                        percent = parseFloat(data[i]["g_gold"] / total * 100).toFixed(2);
                    }
                    var g_gold = data[i]["g_gold"];
                    str_info += "<td>" + g_gold + "</td>";
                    str_info += "<td>" + percent + "%</td>";
                    var c_count = data[i]["c_count"];
                    str_info += "<td>" + c_count + "</td>";
                    var p_count = data[i]["p_count"];
                    str_info += "<td>" + p_count + "</td>";
                    var avg_count = 0;
                    var avg_p_count = 0;
                    if (p_count != 0){
                        avg_count = parseFloat(c_count / p_count).toFixed(2);
                        avg_p_count = parseFloat(g_gold / p_count).toFixed(2);
                    }
                    str_info += "<td>" + avg_count + "</td>";
                    str_info += "<td>" + avg_p_count + "</td>";
                    str_info += '</tr>';

                    var temp = {label: USE_GOLD_TYPE[i],
                                data: data[i]["g_gold"] / total * 100
                    };
                    dataset.push(temp);
                }
                drawPieChart($("#chart_consume"), dataset);
            }
            else{
                str_info += "<tr>";
                str_info += '<td colspan="4" class="text-center"><span class="label label-danger">无数据</span></td>';
                str_info += '</tr>';
            }
            $("#consume_list").html(str_info);
        },
        error: function (XMLHttpRequest) {
            App.unblockUI(page_content);
            error_func(XMLHttpRequest);
        }
    });
});

$("#query_button_level").on("click", function(e){
    e.preventDefault();
//    var partner = $("#user_channel").val();
    var partner = 0;
    var game = $("#select_gameserver").val();
    var start_date = $("#start_level_date").val();
    var end_date = $("#end_level_date").val();
    var page_content = $('.page-content');
    App.blockUI(page_content, false);

    $.ajax({
        type: 'get',
        url: "/querylevelconsume",
        data: {partner: partner, game: game, start_date: start_date, end_date: end_date},
        dataType: 'JSON',
        success: function (data) {
            App.unblockUI(page_content);
            var str_info = "";
            for (var s in data) {
                str_info += "<tr>";
                str_info += "<td>" + data[s]["level"] + "</td>";
                str_info += "<td>" + data[s]["users"] + "</td>";
                str_info += "<td>" + data[s]["usegold"] + "</td>";
                str_info += "<td>" + data[s]["usegold_person"] + "</td>";
                if (data[s]["usegold"] == 0 || data[s]["usegold_person"] == 0) {
                    str_info += "<td>0</td>";
                }
                else {
                    str_info += "<td>" + (data[s]["usegold"] / data[s]["usegold_person"]).toFixed(0) + "</td>";
                }
                str_info += "<td>" + data[s]["recharge_person"] + "</td>";
                str_info += "<td>" + data[s]["recharge_num"] + "</td>";
                str_info += "<td>" + data[s]["getgold"] + "</td>";
                str_info += "</tr>";
            }
            $("#level_consume_list").html(str_info);
        },
        error: function (XMLHttpRequest) {
            App.unblockUI(page_content);
            error_func(XMLHttpRequest);
        }
    })
});

//$("#query_button").click();

$("#a_consume_level").on("click", function(e){
    $("#query_button_level").click();
});